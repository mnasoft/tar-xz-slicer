#!/bin/bash

# === tar-xz-slicer: Stream-friendly –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ ===
# üõ† –£–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–∏ —Å xz-—Å–∂–∞—Ç–∏–µ–º, –Ω–∞—Ä–µ–∑–∞–µ—Ç –Ω–∞ —Å–ª–∞–π—Å—ã –±–µ–∑ tmp-—Ñ–∞–π–ª–æ–≤
# üì§ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ, —Å–∫–ª–µ–∏–≤–∞—è —á–∞—Å—Ç–∏ –Ω–∞ –ª–µ—Ç—É
# üìÖ –í–µ—Ä—Å–∏—è: 0.1 | –ê–≤—Ç–æ—Ä: –ú–∏–∫–æ–ª–∞ + Copilot | –î–∞—Ç–∞: 2025-06-30

# –¶–≤–µ—Ç–∞
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
RED="\033[0;31m"
NC="\033[0m"

log_info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $1"; }

print_usage() {
  echo -e "${YELLOW}USAGE:${NC}"
  echo -e "  tar-xz-slicer pack <–∫–∞—Ç–∞–ª–æ–≥> [—Ä–∞–∑–º–µ—Ä_—Å–ª–∞–π—Å–∞] [–ø—Ä–µ—Ñ–∏–∫—Å] [--progress|--watch]"
  echo -e "     –£–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ –≤ .tar.xz –∏ –¥–µ–ª–∏—Ç –Ω–∞ —Å–ª–∞–π—Å—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1024m)"
  echo -e "     –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:"
  echo -e "       --progress  ‚Äî –±–µ–≥—É–Ω–æ–∫"
  echo -e "       --watch     ‚Äî –≤—ã–≤–æ–¥ –∏–º—ë–Ω —Å–ª–∞–π—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
  echo
  echo -e "  tar-xz-slicer unpack <–ø—Ä–µ—Ñ–∏–∫—Å>"
  echo -e "     –°–∫–ª–µ–∏–≤–∞–µ—Ç —Å–ª–∞–π—Å—ã –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∞—Ä—Ö–∏–≤"
  echo
  echo -e "  tar-xz-slicer --list"
  echo -e "     –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã"
  echo
}

show_spinner() {
  local pid=$1 delay=0.1 spinstr='|/-\'
  while kill -0 "$pid" 2>/dev/null; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  printf "      \b\b\b\b\b\b"
}

watch_slices() {
  local prefix="$1"
  local last_count=0
  local seen=()

  while true; do
    shopt -s nullglob
    local files=( "${prefix}"[0-9][0-9][0-9][0-9][0-9][0-9] )
    for f in "${files[@]}"; do
      if [[ ! " ${seen[*]} " =~ " ${f} " ]]; then
        seen+=("$f")
        echo -e "  ${BLUE}$(basename "$f")${NC}"
      fi
    done
    sleep 1
  done
}


pack_and_slice() {
  local full_path="$1"
  local slice_size="${2:-1024m}"
  local out_prefix="${3:-archive.part.}"
  local mode1="$4"
  local outdir="$(pwd)"

  if [[ ! -d "$full_path" ]]; then
    log_error "–ö–∞—Ç–∞–ª–æ–≥ '$full_path' –Ω–µ –Ω–∞–π–¥–µ–Ω"
    return 1
  fi

  local dirname="$(basename "$full_path")"
  local parentdir="$(dirname "$full_path")"
  log_info "–£–ø–∞–∫–æ–≤–∫–∞ '${dirname}' —Å –Ω–∞—Ä–µ–∑–∫–æ–π –ø–æ ${slice_size}, –ø—Ä–µ—Ñ–∏–∫—Å: ${out_prefix}"

  (
    cd "$parentdir" || exit 1

    [[ "$mode1" == "--watch" ]] && watch_slices "${outdir}/${out_prefix}" &
    [[ "$mode1" == "--progress" ]] && show_spinner $$ &

    tar -c "$dirname" | xz -c | split -b "$slice_size" \
      --suffix-length=6 --numeric-suffixes=0 \
      - "${outdir}/${out_prefix}"
  )

  if [[ $? -eq 0 ]]; then
    log_success "–£–ø–∞–∫–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    [[ "$mode1" != "--watch" ]] && ls -1 "${out_prefix}"* | sort | while read -r f; do
      echo -e "  ${BLUE}$(basename "$f")${NC}"
    done
  else
    log_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ø–∞–∫–æ–≤–∫–µ"
  fi
}


unslice_and_unpack() {
  local slice_prefix="$1"

  if [[ -z "$slice_prefix" ]]; then
    log_error "–ù–µ —É–∫–∞–∑–∞–Ω –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏"
    return 1
  fi

  if ! ls "${slice_prefix}"* &> /dev/null; then
    log_error "–°–ª–∞–π—Å—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º '${slice_prefix}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    return 1
  fi

  log_info "–û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–ª–∞–π—Å—ã –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∞—Ä—Ö–∏–≤..."
  cat "${slice_prefix}"* | xz -d | tar -x

  if [[ $? -eq 0 ]]; then
    log_success "–ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
  else
    log_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ"
    return 1
  fi
}

main() {
  case "$1" in
    pack)
      shift
      if [[ $# -lt 1 ]]; then
        log_warn "–ù–µ —É–∫–∞–∑–∞–Ω –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è —É–ø–∞–∫–æ–≤–∫–∏."
        print_usage
        return 1
      fi
      pack_and_slice "$@"
      ;;
    unpack)
      shift
      if [[ $# -lt 1 ]]; then
        log_warn "–ù–µ —É–∫–∞–∑–∞–Ω –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏."
        print_usage
        return 1
      fi
      unslice_and_unpack "$@"
      ;;
    --help|-h)
      print_usage
      ;;
    --list)
      echo -e "üéõ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
      echo "  pack     ‚Äî –£–ø–∞–∫–æ–≤–∞—Ç—å –∏ –Ω–∞—Ä–µ–∑–∞—Ç—å"
      echo "  unpack   ‚Äî –°–∫–ª–µ–∏—Ç—å –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å"
      echo "  --help   ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"
      echo "  --list   ‚Äî –ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã"
      ;;
    *)
      log_warn "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: '$1'"
      print_usage
      return 1
      ;;
  esac
}

main "$@"
